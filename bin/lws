#!/usr/bin/env node

var lws = module.exports = require('../lib/resources');

var _ = require('lodash');
var fs = require('fs');
var path = require('path');
var program = require('commander');

var configUtil = lws.utils.configUtil;

function runProgram() {
	program
		.version(require('../package.json').version)
		.command('add', 'Add an object to the database.')
		.command('delete', 'Delete an object from the database.')
		.command('get', 'Get an object from the database.')
		.command('config', 'Configure LWS.');

	// Some logic that searches global dirs and finds modules
	// Each calls 'program.command()'

	program.parse(process.argv);

	if (!process.argv.slice(2).length) {
		program.outputHelp();
	}
}

// Check to see if the company ID is valid
lws.actions.getCompany(configUtil.getCurrentHost())
	.then(function(company) {
		var companyId = company.companyId;

		if (configUtil.getCurrentCompanyId() === company.companyId) {
			runProgram();
		}
		else {
			console.log('Updating companyId...');

			var config = configUtil.getCurrentInstanceConfig();

			configUtil.setInstanceConfig(
				configUtil.getCurrentInstanceName(),
				config.username,
				config.password,
				config.host,
				config.port,
				config.portalVersion,
				companyId
			);

			console.log('companyId updated to %j', companyId);

			runProgram();
		}
	})
	.catch(function(error) {
		console.log('error: ', error);
	});
